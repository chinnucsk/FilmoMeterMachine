<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>FilmoMeter - Serving movie nerds since 2013</title>
		<link rel="stylesheet" href="/css/style.css">
	</head>
	<body id="home">
		<div id="layout">
			<header>
				<h1 id="logo">
					<a href="./">Filmo<span class="light">Meter</span></a>
				</h1>
				<h5>Never watch a crappy movie ever again</h5>
			</header>
			<hr class="noscreen">
			<section class="search">
				<form action="">
					<input class="keyword" type="text" placeholder="Movie title"></input>
					<span class="search-icon"></span>
					<div class="spinner"></div>
				</form>
			</section>
			<hr class="noscreen">
			<section class="result">
				<table>
					<tbody>
						<tr>
							<td class="poster">
								<img class="poster" data-bind="attr:{src: $root.ratings()[1].poster}"></img>
							</td>
							<td>
								<ul>
									<li>
										<label>Title:</label>
										<span data-bind="text: $root.ratings()[0].title"></span>
									</li>
									<li>
										<label>Year:</label>
										<span data-bind="text: $root.ratings()[0].year"></span>
									</li>
									<li>
										<label>Actors:</label>
										<span data-bind="text: $root.ratings()[0].actors"></span>
									</li>
									<li>
										<label>Rating:</label>
										<a href="#">
											<span data-bind="text: averageRating"></span>
										</a>
										<div class="individual-results">
											<ul data-bind="foreach: ratings">
												<li>
													<span data-bind="text: source"></span> -
													<span data-bind="text: rating"></span>
												</li>
											</ul>
										</div>
									</li>
									<li>
										<label>Verdict: </label>
										<meter min="0" max="10" title="score" data-bind="attr:{value: averageRating}"></meter>
										<span data-bind="text: verdict"></span>
									</li>
								</ul>
							</td>
						</tr>
					</tbody>
				</table>
			</section>
			<section class="no-result">
				<p>I haz no such movie :(</p>
			</section>
		</div>

		<footer>
			<span class="source"><a href="https://github.com/safwank/FilmoMeterMachine" target="_blank">Source code</a></span>
			<span class="copyright">Â© 2012 <a href="mailto:shaihulud@alumni.cmu.edu?Subject=FilmoMeter%20rocks">Safwan Kamarrudin</a></span>
		</footer>

		<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.0.js"></script>
		<script type="text/javascript" src="https://raw.github.com/SteveSanderson/knockout.mapping/master/build/output/knockout.mapping-latest.js"></script>
		<script type="text/javascript">
			$(document).ready(function() {
				/* Variables */

				var viewModel = {};
				var keyword = $(':text');
  				var spinner = $('.spinner');
  				var result = $('.result');
  				var noResult = $('.no-result');
  				var individualResults = $('.individual-results');
  				var individualResultsShown = false;
  				var bindingsApplied = false;

  				/* Functions */

  				search = function() {
  					if (keyword.val() != '') {
  						showSpinner();
						resetView();

						$.getJSON('/search?title=' + keyword.val(), function(data) {
							hideSpinner();
							bindToViewModel(data);
						});
					}
  				};

  				showSpinner = function() {
  					spinner.css('visibility','visible');
  				};

  				hideSpinner = function() {
  					spinner.css('visibility','hidden');
  				};

  				resetView = function() {
					result.slideUp();
					noResult.slideUp();
					resetIndividualResults();
  				};

  				bindToViewModel = function(data) {
  					if (data == null) {
						noResult.slideDown();
					} else {
						result.slideDown();
								
						if (!bindingsApplied) {
							viewModel = ko.mapping.fromJS(data);
							ko.applyBindings(viewModel);
							bindingsApplied = true;
						} else {
							ko.mapping.fromJS(data, viewModel);
						}
					}
  				};

  				resetIndividualResults = function() {
  					individualResults.slideUp();
  					individualResultsShown = false;
  				};

  				searchIfEnterIsPressed = function(e) {
  					if (e.which == 13) {
						search();
					}
  				};

  				toggleIndividualResultsDisplay = function(e) {
					e.preventDefault();

					if (individualResultsShown) {
						resetIndividualResults();
					} else {
						individualResults.slideDown();
						individualResultsShown = true;
					}
				}

				/* Events */
				
				$('form').submit(function(e){
					e.preventDefault();
				});

				keyword.keypress(searchIfEnterIsPressed);

				$('.result a').click(toggleIndividualResultsDisplay);
			});
		</script>
		<script type="text/javascript">
			var _gaq = _gaq || [];
		  	_gaq.push(['_setAccount', 'UA-37268765-1']);
		  	_gaq.push(['_trackPageview']);

		  	(function() {
		    	var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    	ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    	var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  	})();
		</script>
	</body>
</html>